generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Модель пользователя (под Telegram Mini App)
model User {
  id                   String        @id @default(cuid())
  telegramId           String?       @unique
  cyberLogin           String        @unique
  username             String?
  firstName            String?
  lastName             String?
  tronAddress          String        @unique
  encryptedPrivateKey  String
  encryptedMnemonic    String
  referralCode         String        @unique
  referredBy           String?
  balanceRUB           Float         @default(0)
  referralBalance      Float         @default(0)
  totalDeals           Int           @default(0)
  totalVolume          Float         @default(0)
  isVerified           Boolean       @default(false)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Связи
  wallets              Wallet[]
  transactions         Transaction[]
  withdrawals          Withdrawal[]
  exchanges            Exchange[]
  referrals            User[]        @relation("Referrals")
  referrer             User?         @relation("Referrals", fields: [referredBy], references: [referralCode], onDelete: SetNull)
}

// Модель кошелька
model Wallet {
  id           String        @id @default(cuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency     String        // RUB, USDT, TRX
  balance      Float         @default(0)
  address      String?       // Для криптовалют
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  transactions Transaction[]
  withdrawals  Withdrawal[]

  @@unique([userId, currency])
}

// Модель транзакций
model Transaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  type        String   // DEPOSIT, WITHDRAWAL, TRANSFER, EXCHANGE
  amount      Float
  currency    String
  status      String   // PENDING, COMPLETED, FAILED, CANCELLED
  description String?
  metadata    String?  // JSON данные
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Модель заявок на вывод наличных
model Withdrawal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  amount      Float
  currency    String
  status      String   // PENDING, APPROVED, COMPLETED, CANCELLED
  token       String   @unique
  city        String   // moscow, nnov, kgd
  fullName    String
  contactType String   // telegram or phone
  contact     String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ✅ НОВАЯ МОДЕЛЬ: Администраторы
model Admin {
  id          String   @id @default(cuid())
  telegramId  String   @unique
  username    String?
  firstName   String?
  lastName    String?
  role        String   // SUPER_ADMIN, EXCHANGE_OPERATOR, WITHDRAWAL_OPERATOR
  city        String?  // Для операторов выдачи (moscow, nnov, kgd)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Связь с обработанными заявками
  exchanges   Exchange[]
}

// ✅ НОВАЯ МОДЕЛЬ: Обмены валют
model Exchange {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Тип обмена
  type              String    // USDT_TO_RUB, RUB_TO_USDT
  
  // Суммы
  fromAmount        Float
  fromCurrency      String
  toAmount          Float
  toCurrency        String
  
  // Курс показанный пользователю
  exchangeRate      Float
  
  // Статус
  status            String    // PENDING, PENDING_APPROVAL, APPROVED, COMPLETED, CANCELLED
  
  // Транзакция (для USDT → RUB)
  txid              String?
  
  // Данные откупа (заполняет администратор)
  adminId           String?
  admin             Admin?    @relation(fields: [adminId], references: [id])
  buyoutRate        Float?    // Курс откупа администратором
  buyoutAmount      Float?    // Сумма откупа в RUB
  profit            Float?    // Прибыль компании
  
  // Дополнительные данные для RUB → USDT
  destinationAddress String? // Адрес куда отправить USDT
  
  // Временные метки
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  completedAt       DateTime?

  @@index([userId])
  @@index([status])
  @@index([type])
}